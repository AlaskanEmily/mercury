#-----------------------------------------------------------------------------#

main_target: check

include ../Mmake.common

#-----------------------------------------------------------------------------#

ifeq ($(HAVE_NUPROLOG),yes)
%.exp: %.nu
	{ [ -f $*.inp ] && cat $*.inp; } | ./$< > $@ 2>&1;
endif

#-----------------------------------------------------------------------------#

NONDETPROGS=	commit_bug disj_disj dnf hello_again interpreter \
		nasty_nondet nondet_disj nondet_ite nondet_ite_2 \
		nondetlive partition semidet_lambda

DETPROGS=	arithmetic det_complicated_unify duplicate_label \
		environment higher_order parse_list petdr1 \
		semidet_map set_test string__format_test string_test \
		string_test_2 univ unreachable float_test \
		mode_inf_bug

# The `liveness' test doesn't work yet, due to bugs
# in the compiler.  Ditto for frameopt_mkframe_bug.
NOTWORKING=	liveness frameopt_mkframe_bug

#
# The nondet tests use solutions/2, which is currently implemented only for GC
# grades.  So only include those tests if the grade is a GC grade.
#

ifeq ("$(findstring .gc, $(GRADE))","")
PROGS=$(DETPROGS)
else
PROGS=$(DETPROGS) $(NONDETPROGS)
endif

# mode_inf_bug needs to be compiled with `--infer-all'.
mode_inf_bug.c: mode_inf_bug.m
	$(MCG) --grade $(GRADE) $(MCGFLAGS) --infer-all mode_inf_bug.m \
		> mode_inf_bug.err 2>&1

DEPENDS=$(PROGS:%=%.depend)
OUTS=	$(PROGS:%=%.out)
EXPS=	$(PROGS:%=%.exp)
RESS=	$(PROGS:%=%.res)
MODS=	$(PROGS:%=%.mod)

depend: $(DEPENDS)

exp:	$(EXPS)

check:	$(OUTS) $(RESS)

mods:	$(MODS)

all:	$(PROGS)

clean:
	rm -f *.c *.o *.err2 *.d *.dep *.nu *.nu.save

#-----------------------------------------------------------------------------#
