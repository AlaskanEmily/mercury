#-----------------------------------------------------------------------------#

THIS_DIR = tabling

#-----------------------------------------------------------------------------#

SIMPLE_NONLOOP_PROGS = \
	boyer \
	expand \
	expand_float \
	expand_poly \
	expand_tuple \
	fast_loose \
	fib \
	fib_float \
	fib_list \
	fib_string \
	loopcheck_no_loop \
	loopcheck_nondet_no_loop \
	oota \
	table_foreign_output \
	test_enum \
	unused_args

# Tabling of nondet predicates and deep profiling are (currently)
# incompatible.
ifeq "$(findstring profdeep,$(GRADE))" ""
	BROKEN_FOR_PROFDEEP_NONLOOP_PROGS = \
		memo_non
else
	BROKEN_FOR_PROFDEEP_NONLOOP_PROGS = 
endif

SIMPLE_LOOP_PROGS = \
	loopcheck \
	loopcheck_nondet \
	tc_loop \
	tc_memo \
	tc_memo2

MINIMAL_NONLOOP_PROGS = \
	combine \
	completed_consumer_in_solutions \
	consumer_in_commit \
	consumer_in_solutions \
	coup \
	coup2 \
	coup3 \
	coup4 \
	coup_det_frame \
	coup_no_commit \
	coup_non_tabled_frame \
	generator_in_commit \
	mday \
	repeat \
	rotate \
	rotate2 \
	seq \
	seq2 \
	seq3 \
	seq4 \
	sg \
	tc_minimal \
	tc_minimal2

MINIMAL_LOOP_PROGS =

# The following programs do not work:
#	semidet_minimal.m
#	tc_minimal_semidet.m

ALL_SIMPLE_PROGS = $(SIMPLE_NONLOOP_PROGS) \
			$(BROKEN_FOR_PROFDEEP_NONLOOP_PROGS) \
			$(SIMPLE_LOOP_PROGS)

ALL_MINIMAL_PROGS = $(MINIMAL_NONLOOP_PROGS)

# Tabling does not yet work in .rt grades
ifneq "$(findstring .gc,$(GRADE))" ""
	ifneq "$(findstring .rt,$(GRADE))" ""
		PROGS=
		NONLOOP_PROGS=
	else
		ifneq "$(findstring mm,$(GRADE))" ""
			PROGS=$(ALL_SIMPLE_PROGS) $(ALL_MINIMAL_PROGS)
			NONLOOP_PROGS=$(SIMPLE_NONLOOP_PROGS) \
				$(MINIMAL_NONLOOP_PROGS)
		else
			PROGS=$(ALL_SIMPLE_PROGS)
			NONLOOP_PROGS=$(SIMPLE_NONLOOP_PROGS)
		endif
	endif
else
	PROGS=
endif

TESTS = $(PROGS)
SUBDIRS=
TESTS_DIR=..
include $(TESTS_DIR)/Mmake.common

# Module-specific options should go in Mercury.options so they
# can be found by `mmc --make'.
include Mercury.options

%.runtest: %.res ;

#-----------------------------------------------------------------------------#

# Some test cases are expected to abort.
# We also need to pipe the output for these test cases through sed to avoid
# hard-coding dependencies on particular line numbers in the standard library
# source code.

tc_loop.out: tc_loop
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			-e 's/std_util.m:[0-9]*/std_util.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

tc_memo.out: tc_memo
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			-e 's/std_util.m:[0-9]*/std_util.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

tc_memo2.out: tc_memo2
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			-e 's/std_util.m:[0-9]*/std_util.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

loopcheck.out: loopcheck
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

loopcheck_nondet.out: loopcheck_nondet
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

consumer_in_solutions.out: consumer_in_solutions
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		mv $@.tmp $@ ; \
	fi

.PHONY: echo_progs
echo_progs:
	@echo $(PROGS)

.PHONY: echo_nonloop_progs
echo_nonloop_progs:
	@echo $(NONLOOP_PROGS)

.PHONY: echo_minimal_nonloop_progs
echo_minimal_nonloop_progs:
	@echo $(MINIMAL_NONLOOP_PROGS)

.PHONY: echo_simple_nonloop_progs
echo_simple_nonloop_progs:
	@echo $(SIMPLE_NONLOOP_PROGS)

#-----------------------------------------------------------------------------#
