#! /bin/sh
# @configure_input@
#---------------------------------------------------------------------------#
# Copyright (C) 1995-1998 The University of Melbourne.
# This file may only be copied under the terms of the GNU General
# Public License - see the file COPYING in the Mercury distribution.
#---------------------------------------------------------------------------#
#
# mmake - Mercury Make.
#
#	Type mmake -h for help.
#
#-----------------------------------------------------------------------------#

# IMPORTANT: the manpage is produced automatically from this help
# message, so if you change the help message, don't forget to check
# that the manpage still looks OK.
Help="\
Name: mmake -- Mercury Make
Usage: mmake [<mmake options>] [-- <make options>] <target>...
Options:
	--use-subdirs:
		Build intermediate files in a \`Mercury' subdirectory,
		rather than in the current directory.
		(If the current directory already contains a \`Mercury'
		subdirectory, then this option is the default.)
	-s, --save-makefile:
		Save the generated makefile to \`Mmake.makefile'.
		This is useful for tracking down syntax errors in
		your Mmake file.
	-v, --verbose:
		Print verbose progress messages.
	-h, --help:
		Print this usage message.
Targets:
	<module>.depend:
		Make the file \`<module>.dep'.  This step is required
		in preparation for the targets below.
	<module>:
		Compile and link a Mercury program with main module
		\`<module>.m' to produce an executable.
	<module>.nu:
		Compile and link a Mercury program with NU-Prolog
		rather than with the Mercury compiler.
	<module>.sicstus:
		Compile and link a Mercury program with SICStus Prolog
		rather than with the Mercury compiler.
	<module>.nu.debug:
	<module>.sicstus.debug:
		Debugging versions of the above.
	clean:
		Remove intermediate files.
	realclean:
		Remove all automatically-generated files: intermediate files,
		dependency files, and executables.
"

MMAKE_MAKE=${MMAKE_MAKE=@GNU_MAKE@}
MMAKE_DIR=${MMAKE_DIR=@LIBDIR@/mmake}
MMAKE_VARS=${MMAKE_VARS=$MMAKE_DIR/Mmake.vars}
MMAKE_RULES=${MMAKE_RULES=$MMAKE_DIR/Mmake.rules}
MERCURY_INT_DIR=${MERCURY_INT_DIR=@LIBDIR@/ints}
MERCURY_DEFAULT_GRADE=${MERCURY_DEFAULT_GRADE=@DEFAULT_GRADE@}
MKTEMP=@MKTEMP@

MMAKE=$0
verbose=false
save_makefile=false
use_subdirs=${MMAKE_USE_SUBDIRS=`
	if [ -d Mercury ]; then echo yes; else echo no; fi`}

while [ $# -gt 0 ]; do
	case "$1" in
		-h|--help)
			echo "$Help"
			exit 0
			;;
		--use-subdirs)
			use_subdirs=yes
			shift
			;;
		--no-use-subdirs)
			use_subdirs=no
			shift
			;;
		-s|--save-makefile)
			save_makefile=true
			MMAKE="$MMAKE $1"
			shift
			;;
		-s-|--no-save-makefile)
			save_makefile=false
			MMAKE="$MMAKE $1"
			shift
			;;
		-v|--verbose)
			verbose=true
			MMAKE="$MMAKE $1"
			shift
			;;
		-v-|--no-verbose)
			verbose=false
			MMAKE="$MMAKE $1"
			shift
			;;
		--)	
			MMAKE="$MMAKE $1"
			shift
			break
			;;
		*)
			break
			;;
	esac
done

if [ -f Mmakefile ]; then
	mmake="Mmakefile"
else
	if [ -f Mmake ]; then
		mmake="Mmake"
	else
		mmake=""
	fi
fi

case $use_subdirs in
	no)
		deps="`echo *.dep`"
		if [ "$deps" = "*.dep" ]; then
			deps=""
		fi
		ds="`echo *.d`"
		if [ "$ds" = "*.d" ]; then
			ds=""
		fi
		;;
	yes)
		deps="`echo Mercury/deps/*.dep`"
		if [ "$deps" = "Mercury/deps/*.dep" ]; then
			deps=""
		fi
		ds="`echo Mercury/ds/*.d`"
		if [ "$ds" = "Mercury/ds/*.d" ]; then
			ds=""
		fi
		;;
esac

MMAKE_USE_SUBDIRS=$use_subdirs

if $save_makefile; then
	tmp=Mmake.makefile
else
	case "$MKTEMP" in
		"") 	old_umask=`umask`
			umask 022
			mmake_tmpdir=/tmp/mmake$$
			tmp=$mmake_tmpdir/mmake
			if mkdir $mmake_tmpdir ; then
				true
			else
				echo "Unable to create temporary makefile" 1>&2
				exit 1
			fi
			trap 'status=$?; rm -rf $mmake_tmpdir; exit $status' 0 1 2 3 13 15
			umask $old_umask
			;;
		*)
			# mktemp should give its own error message.
			tmp=`$MKTEMP /tmp/mmake.XXXXXX` || exit 1
			trap 'status=$?; rm -f $tmp; exit $status' 0 1 2 3 13 15
			;;
	esac
fi

MMAKE_MAKE_CMD="${MMAKE_MAKE} -f $tmp -r"

# Enable checking for undefined variables -- but not when making the
# dependencies, or when cleaning up, because in either of those two
# cases the dependencies might not have been made yet, so there may be
# lots of undefined variables.
case "$@" in
	dep*|' dep'*|*.dep*|*clean*)
		MMAKE_MAKE_OPTS=""
		;;
	*)
		MMAKE_MAKE_OPTS="--warn-undefined-variables"
		;;
esac

if $verbose; then
	echo MMAKE=$MMAKE
	echo export MMAKE
	echo MMAKE_MAKE_CMD=$MMAKE_MAKE_CMD
	echo export MMAKE_MAKE_CMD
	echo MMAKE_USE_SUBDIRS=$MMAKE_USE_SUBDIRS
	echo export MMAKE_USE_SUBDIRS
	echo MERCURY_INT_DIR=$MERCURY_INT_DIR
	echo export MERCURY_INT_DIR
	echo MERCURY_DEFAULT_GRADE=$MERCURY_DEFAULT_GRADE
	echo export MERCURY_DEFAULT_GRADE
	echo cat ${MMAKE_VARS} $deps $ds $mmake ${MMAKE_RULES} ">>" $tmp
	echo ${MMAKE_MAKE} ${MMAKE_MAKE_OPTS} -f $tmp -r "$@"
fi
export MMAKE
export MMAKE_MAKE_CMD
export MMAKE_USE_SUBDIRS
export MERCURY_INT_DIR
export MERCURY_DEFAULT_GRADE
cat ${MMAKE_VARS} $deps $ds $mmake ${MMAKE_RULES} > $tmp
case $# in
	# Note that we can't use `exec' here, because if we did that,
	# that `trap' code which removes $tmp would never get executed.
	0) ${MMAKE_MAKE} -f $tmp -r ;;
	*) ${MMAKE_MAKE} ${MMAKE_MAKE_OPTS} -f $tmp -r "$@" ;;
esac
