#-----------------------------------------------------------------------------#

THIS_DIR = tabling

#-----------------------------------------------------------------------------#

SIMPLE_PROGS = \
	boyer \
	expand \
	expand_float \
	expand_poly \
	expand_tuple \
	fib \
	fib_float \
	fib_list \
	fib_string \
	loopcheck \
	loopcheck_no_loop \
	unused_args

NONDET_PROGS = \
	combine \
	completed_consumer_in_solutions \
	consumer_in_commit \
	coup \
	coup_det_frame \
	coup_no_commit \
	coup_non_tabled_frame \
	generator_in_commit \
	mday \
	repeat \
	seq \
	seq2 \
	seq3 \
	seq4 \
	sg \
	tc_loop \
	tc_minimal

# We don't yet pass the following minimal model tests. The reason is that
# they contain interactions between tabling and constructs that function
# as committed or negated contexts.
#
#	consumer_in_solutions
#
# We don't yet pass the following minimal model tests for undetermined reasons.
#
#	coup2

# Tabling does not yet work in .rt grades
ifneq "$(findstring .gc,$(GRADE))" ""
	ifneq "$(findstring .rt,$(GRADE))" ""
		PROGS=
	else
		ifneq "$(findstring .mm,$(GRADE))" ""
			PROGS=$(SIMPLE_PROGS) $(NONDET_PROGS)
		else
			PROGS=$(SIMPLE_PROGS)
		endif
	endif
else
	PROGS=
endif

TESTS = $(PROGS)
SUBDIRS=
TESTS_DIR=..
include $(TESTS_DIR)/Mmake.common

# Module-specific options should go in Mercury.options so they
# can be found by `mmc --make'.
include Mercury.options

%.runtest: %.res ;

#-----------------------------------------------------------------------------#

# Some test cases are expected to abort.
# We also need to pipe the output for these test cases through sed to avoid
# hard-coding dependencies on particular line numbers in the standard library
# source code.

tc_loop.out: tc_loop
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			-e 's/std_util.m:[0-9]*/std_util.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

loopcheck.out: loopcheck
	if ./$< > $@.tmp 2>&1; then \
		grep . $@.tmp; \
		exit 1; \
	else \
		sed	-e 's/exception.m:[0-9]*/exception.m:NNNN/g' \
			-e 's/require.m:[0-9]*/require.m:NNNN/g' \
			< $@.tmp > $@; \
		rm -f $@.tmp; \
	fi

#-----------------------------------------------------------------------------#
